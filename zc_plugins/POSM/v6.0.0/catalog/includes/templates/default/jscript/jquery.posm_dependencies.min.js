// -----
// Part of the "Product Options Stock Manager" plugin by Cindy Merkin
// Copyright (c) 2014-2024 Vinos de Frutas Tropicales
//
// Last updated: v5.0.0
//
$((function(){attributeWrapper===wrapperAttribsOptions&&($(attributeWrapper).each((function(){$(this).nextUntil(wrapperAttribsOptions).addBack().wrapAll('<div class="posm-wrapper"></div>')})),attributeWrapper=".posm-wrapper");let e,t=null,o=0;if($(attributeWrapper).each((function(){let e=!1;if($(this).find(inputTypes).length>0){let s=$(this).find(inputTypesFirst).attr("name").match(/\d+/g);-1===ignoreOptionsList.indexOf(Number(s[0]))&&(null===t?(o=s,$(this).addClass("posm-active"),t=$(this),e=!0,isSingleOption||($(this).find("select").length>0?$(this).find("option:selected").prop("selected",!1):$(this).find('input[type="radio"]:checked').prop("checked",!1))):($(this).removeClass("posm-active"),$(this).find(inputTypesFirst).each((function(){s=$(this).attr("name").match(/\d+/g),-1===ignoreOptionsList.indexOf(Number(s[0]))&&$(this).prop("disabled",!0)}))),isSingleOption||($(this).find("select").length>0?$(this).find("option:selected").prop("selected",!1):($(this).find('input[type="radio"]:checked').prop("checked",!1),e||($(this).children().children().not(optionNameSelector).hide(),$(this).find(attribImgSelector).hide(),$(this).find(optionNameSelector).append(' <span class="posm-prev-choices">'+radioButtonChoose+"</span>")))))}})),insertPleaseChoose){let e=!1;$(wrapperAttribsOptions+" select").each((function(){let t=$(this).attr("name").match(/\d+/g);-1===ignoreOptionsList.indexOf(Number(t[0]))&&(e?$(this).prepend($('<option value="0" selected="selected">'+pleaseChooseNextText+"</option>")):(e=!0,$(this).prepend($('<option value="0" selected="selected">'+pleaseChooseText+"</option>"))))}))}"function"==typeof console.log&&console.log("firstGroup optionID: "+o),!1===isSingleOption&&($(t).find('input[type="radio"]:checked').prop("checked",!1),$(t).find("select :selected").prop("selected",!1),$(t).find("select option:first").prop("selected",!0),$(document).on("click",'#productAttributes option:selected, #productAttributes input[type="radio"]:checked',(function(){$(this).trigger("change")}))),zcJS.ajax({url:"ajax.php?act=ajaxOptionsStockDependencies&method=availableOptionValues",data:{products_id:$('input[name="products_id"]').val(),options_id:o,selected_values:"",calling_page:"'"+callingPage+"'",calling_pid:callingPid}}).done((function(e){if(!0===e.error)$("#posm_message").html(e.error_message),window.console&&"function"==typeof console.log&&console.log(e.error_message);else{lastSelection=e.last_selection,$(t).children().children().not(optionNameSelector).hide();for(let o=0,s=e.option_values.length;o<s;o++){let s=$(t).find("select option[value="+e.option_values[o].options_values_id+"]");0!==s.length&&s.prop("disabled",!1);let n=$(t).find('input[type="radio"][value="'+e.option_values[o].options_values_id+'"]');lastSelection&&(e.option_values[o].quantity>0?(outOfStockClass="in-stock",outOfStockMessage=inStockMessage.replace("%u",e.option_values[o].quantity)):(outOfStockClass="no-stock",outOfStockMessage=e.option_values[o].oos_message),0!==s.length?(showModelNum&&0!==e.option_values[o].model.length&&s.append(' <span class="posm-model-num">['+e.option_values[o].model+"]</span>"),""!==outOfStockMessage&&s.append(' <span class="posm-stock-msg">['+outOfStockMessage+"]</span>"),""!==e.option_values[o].extra_info&&s.append(' <span class="posm-stock-msg">'+e.option_values[o].extra_info+"</span>"),s.removeClass(),s.addClass(outOfStockClass)):0!==n.length&&(showModelNum&&0!==e.option_values[o].model.length&&n.next().append(' <span class="posm-model-num">['+e.option_values[o].model+"]</span>"),""!==outOfStockMessage&&n.next().append(' <span class="'+outOfStockClass+' posm-stock-msg">['+outOfStockMessage+"]</span>"),""!==e.option_values[o].extra_info&&n.next().append(' <span class="posm-stock-msg">'+e.option_values[o].extra_info+"</span>")),allowCheckout||"no-stock"!==outOfStockClass||(0!==s.length?(s.prop("disabled",!0),s.prop("selected",!1)):0!==n.length&&(n.prop("disabled",!0),n.prop("checked",!1)))),$(t).show().children().children().show()}}})),$(document).on("change",'#productAttributes select, #productAttributes input[type="radio"]',(function(t){let s=$(t.target);$(".posm-error").remove();let n=t.target.value;window.console&&"function"==typeof console.log&&console.log("Changed value: "+n),o=0;let i=$(s).closest(attributeWrapper);if($(i).nextAll(attributeWrapper).each((function(){if(0===$(this).find(inputTypes).length)return;$(this).removeClass("posm-active");let t=$(this).find(inputTypes);if($(t).length>0){let s=$(t).attr("name").match(/\d+/g);-1===ignoreOptionsList.indexOf(Number(s[0]))&&($(this).find(".posm-prev-choices").remove(),0===o?(e=$(this),o=s):$(t).prop("disabled",!0),$(t).is("select")?($(t).find("option:selected").prop("selected",!1),$(t).find("option:first").prop("selected",!0)):($(t).prop("checked",!1),o!==s&&($(this).find(optionNameSelector).append(' <span class="posm-prev-choices">'+radioButtonChoose+"</span>"),$(this).children().children().not(optionNameSelector).hide(),$(this).find(attribImgSelector).hide())))}})),window.console&&"function"==typeof console.log&&console.log("nextOptionGroup optionID: "+o),0===o)return;let a="";$("#productAttributes "+attributeWrapper+".posm-active").each((function(){let e=$(this).find('select option:selected, input[type="radio"]:checked');$(e).length>0&&(""!==a&&(a+=","),$(e).is("option")?a+=$(e).parent("select").attr("name").match(/\d+/g):a+=$(e).attr("name").match(/\d+/g),a+=":"+$(e).val())})),window.console&&"function"==typeof console.log&&console.log("currentSelections: ("+a+")"),zcJS.ajax({url:"ajax.php?act=ajaxOptionsStockDependencies&method=availableOptionValues",data:{products_id:$('input[name="products_id"]').val(),options_id:o,selected_values:"'"+a+"'",calling_page:"'"+callingPage+"'",calling_pid:callingPid}}).done((function(t){if(!0===t.error)$("#posm_message").html(t.error_message),window.console&&"function"==typeof console.log&&console.log(t.error_message);else{lastSelection=t.last_selection,$(e).addClass("posm-active"),$(e).children().children().not(optionNameSelector).hide(),$(e).find("select option").hide(),$(e).find("select option").prop("disabled",!0);let o=!1;0===$(e).find(attribImgSelector+' > input[type="radio"]').length?(o=!0,$(e).find('input[type="radio"]').nextUntil('input[type="radio"]').addBack().hide()):$(e).find(attribImgSelector).hide(),$(e).find(inputTypes).each((function(){$(this).prop("disabled",!1)})),$(e).find(".posm-stock-msg, .posm-model-num").each((function(){$(this).remove()}));for(let o=0,s=t.option_values.length;o<s;o++){let s=$(e).find("select option[value="+t.option_values[o].options_values_id+"]"),n=$(e).find('input[type="radio"][value="'+t.option_values[o].options_values_id+'"]');lastSelection&&(t.option_values[o].quantity>0?(outOfStockClass="in-stock",outOfStockMessage=inStockMessage.replace("%u",t.option_values[o].quantity)):(outOfStockClass="no-stock",outOfStockMessage=t.option_values[o].oos_message),0!==s.length&&(s.prop("disabled",!1),showModelNum&&0!==t.option_values[o].model.length&&s.append(' <span class="posm-model-num">['+t.option_values[o].model+"]</span>"),""!==outOfStockMessage&&s.append(' <span class="posm-stock-msg">['+outOfStockMessage+"]</span>"),""!==t.option_values[o].extra_info&&s.append(' <span class="posm-stock-msg">'+t.option_values[o].extra_info+"</span>"),s.removeClass(),s.addClass(outOfStockClass)),0!==n.length&&(showModelNum&&0!==t.option_values[o].model.length&&n.next().append(' <span class="posm-model-num">['+t.option_values[o].model+"]</span>"),""!==outOfStockMessage&&n.next().append(' <span class="'+outOfStockClass+' posm-stock-msg">['+outOfStockMessage+"]</span>"),""!==t.option_values[o].extra_info&&n.next().append(' <span class="posm-stock-msg">'+t.option_values[o].extra_info+"</span>")),allowCheckout||"no-stock"!==outOfStockClass||(0!==s.length?(s.prop("disabled",!0),s.prop("selected",!1)):0!==n.length&&(n.prop("disabled",!0),n.prop("checked",!1)))),0!==s.length?(s.closest(attributeWrapper).show().children().children().show(),s.prop("disabled",!1),s.show()):0!==n.length&&(n.closest(attributeWrapper).show().children().children().show(),n.parent().hasClass(attribImgSelector.substring(1,attribImgSelector.length))?n.parent().show():n.nextUntil('input[type="radio"]').addBack().show())}o&&$(e).find(attribImgSelector).show()}0!==t.extra_functions.length&&("function"==typeof console.log&&console.log("Processing extra functions..."),$.each(t.extra_functions,(function(e,t){window[e](t)})))}))})),$(document).on("submit",'form[name="cart_quantity"]',(function(e){let t=!0,o="";return $(".posm-error").remove(),$(attributeWrapper+".posm-active").each((function(){if($(this).find(inputTypes).length>0&&(0===$(this).find('option:selected, input[type="radio"]:checked').length||0!==$(this).find("option[value=0]:selected").length)){t=!1,o=$(this).find(optionNameSelector);let e=o.text().replace(/:/g,"");o.after('<span class="posm-error">'+noSelectionText+e+"</span>")}})),!1===t&&(e.stopImmediatePropagation(),e.preventDefault(),$("html, body").stop().animate({scrollTop:$(o).parent().offset().top},1e3)),t}))}));